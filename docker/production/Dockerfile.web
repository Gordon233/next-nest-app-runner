# 构建阶段
FROM node:20-alpine AS builder

RUN npm install -g pnpm

WORKDIR /app

# 复制配置文件
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY api/package.json ./api/
COPY web/package.json ./web/

# 安装依赖
RUN pnpm install --frozen-lockfile

# 复制源码
COPY api ./api
COPY web ./web

# 构建 Web 应用
WORKDIR /app/web

# 设置环境变量（Next.js 构建时需要）
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL

RUN pnpm build

# 生产阶段
FROM node:20-alpine AS production

RUN npm install -g pnpm

WORKDIR /app

# 复制配置文件
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY api/package.json ./api/
COPY web/package.json ./web/

RUN pnpm install --frozen-lockfile

# 复制构建产物和必要文件
COPY --from=builder /app/web/.next ./web/.next
COPY --from=builder /app/web/public ./web/public
COPY --from=builder /app/web/package.json ./web/
COPY --from=builder /app/web/next.config.ts ./web/
COPY --from=builder /app/web/node_modules ./web/node_modules

WORKDIR /app/web

EXPOSE 3000

CMD ["pnpm", "start"]